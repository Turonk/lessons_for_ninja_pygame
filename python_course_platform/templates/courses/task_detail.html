{% extends 'base.html' %}
{% load static %}

{% block title %}{{ task.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'courses:home' %}">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li class="breadcrumb-item"><a href="{% url 'courses:topic_detail' task.topic.pk %}">{{ task.topic.title }}</a></li>
                <li class="breadcrumb-item active">{{ task.title }}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row">
    <!-- –ó–∞–¥–∞–Ω–∏–µ -->
    <div class="col-lg-5">
        <div class="card mb-4">
            <div class="card-header">
                <h4 class="mb-0">{{ task.title }}</h4>
                {% if progress %}
                    <small class="text-muted">
                        –°—Ç–∞—Ç—É—Å:
                        {% if progress.status == 'completed' %}
                            <span class="badge bg-success">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                        {% elif progress.status == 'in_progress' %}
                            <span class="badge bg-warning">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>
                        {% else %}
                            <span class="badge bg-secondary">–ù–µ –Ω–∞—á–∞—Ç–æ</span>
                        {% endif %}
                        | –õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {{ progress.best_score }}%
                    </small>
                {% endif %}
            </div>
            <div class="card-body">
                <p class="lead">{{ task.description }}</p>

                {% if task.hint %}
                    <div class="alert alert-info">
                        <h6>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞:</h6>
                        <p class="mb-0">{{ task.hint }}</p>
                    </div>
                {% endif %}

                {% if task.example_code %}
                    <details class="mb-3">
                        <summary class="btn btn-outline-secondary btn-sm">üìù –ü—Ä–∏–º–µ—Ä —Ä–µ—à–µ–Ω–∏—è</summary>
                        <pre class="mt-2"><code>{{ task.example_code }}</code></pre>
                    </details>
                {% endif %}

                {% if user.is_admin and test_cases %}
                    <details class="mt-3">
                        <summary class="btn btn-outline-warning btn-sm">üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Å–ª—É—á–∞–∏ (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤)</summary>
                        <div class="mt-2">
                            {% for test_case in test_cases %}
                                <div class="mb-2 p-2 border rounded">
                                    <strong>{{ test_case.description }}</strong><br>
                                    <small class="text-muted">
                                        –¢–∏–ø: {{ test_case.get_test_type_display }}
                                        {% if test_case.variable_name %}| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è: {{ test_case.variable_name }}{% endif %}
                                    </small>
                                </div>
                            {% endfor %}
                        </div>
                    </details>
                {% endif %}
            </div>
        </div>

        {% if progress %}
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìä –¢–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>–°—Ç–∞—Ç—É—Å:</strong>
                        {% if progress.status == 'completed' %}
                            <span class="badge bg-success">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>
                        {% elif progress.status == 'in_progress' %}
                            <span class="badge bg-warning">üîÑ –í –ø—Ä–æ—Ü–µ—Å—Å–µ</span>
                        {% else %}
                            <span class="badge bg-secondary">‚è≥ –ù–µ –Ω–∞—á–∞—Ç–æ</span>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <strong>–ü–æ–ø—ã—Ç–æ–∫:</strong> {{ progress.attempts_count }}
                    </div>

                    <div class="mb-3">
                        <strong>–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong> {{ progress.best_score }}%
                    </div>

                    {% if progress.completed_at %}
                        <div class="mb-3">
                            <strong>–ó–∞–≤–µ—Ä—à–µ–Ω–æ:</strong> {{ progress.completed_at|date:"d.m.Y H:i" }}
                        </div>
                    {% endif %}

                    <div class="progress">
                        <div class="progress-bar" role="progressbar"
                             style="width: {{ progress.best_score }}%"
                             aria-valuenow="{{ progress.best_score }}"
                             aria-valuemin="0" aria-valuemax="100">
                            {{ progress.best_score }}%
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- –†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞ -->
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">‚úèÔ∏è –¢–≤–æ–π –∫–æ–¥</h5>
                <button id="run-code" class="btn btn-success">
                    ‚ñ∂Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥
                </button>
            </div>
            <div class="card-body">
                <form id="code-form">
                    {% csrf_token %}
                    <textarea id="code-editor" name="code" class="form-control" rows="20"
                              placeholder="–ù–∞–ø–∏—à–∏ —Å–≤–æ–π –∫–æ–¥ –∑–¥–µ—Å—å...">{{ task.example_code }}</textarea>
                </form>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ -->
        <div id="results-section" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏</h5>
                </div>
                <div class="card-body">
                    <div id="results-content">
                        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å—é–¥–∞ —á–µ—Ä–µ–∑ JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let editor;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º CodeMirror
    if (document.getElementById('code-editor')) {
        editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            lineNumbers: true,
            mode: 'python',
            theme: 'monokai',
            indentUnit: 4,
            indentWithTabs: false,
            lineWrapping: true,
            viewportMargin: Infinity
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥"
    document.getElementById('run-code').addEventListener('click', function() {
        const code = editor.getValue();
        const button = this;

        if (!code.trim()) {
            alert('–ù–∞–ø–∏—à–∏ –∫–æ–¥ –ø–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π!');
            return;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        button.disabled = true;
        button.innerHTML = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º...';

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch('{% url "courses:submit_code" task.pk %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: new URLSearchParams({
                'code': code
            })
        })
        .then(response => response.json())
        .then(data => {
            displayResults(data);
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            displayResults({
                success: false,
                error: '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É',
                tests: []
            });
        })
        .finally(() => {
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            button.disabled = false;
            button.innerHTML = '‚ñ∂Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥';
        });
    });

    function displayResults(data) {
        const resultsSection = document.getElementById('results-section');
        const resultsContent = document.getElementById('results-content');

        resultsSection.style.display = 'block';

        let html = '';

        // –û–±—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if (data.success) {
            const score = data.score || 0;
            const passedCount = data.passed_count || 0;
            const totalCount = data.total_count || 0;

            html += `<div class="alert alert-${score === 100 ? 'success' : 'warning'} mb-4">`;
            html += `<h5>${score === 100 ? 'üéâ –û—Ç–ª–∏—á–Ω–æ!' : 'üîÑ –ü—Ä–æ–¥–æ–ª–∂–∞–π!'}</h5>`;
            html += `<p>–ü—Ä–æ—à–ª–æ —Ç–µ—Å—Ç–æ–≤: ${passedCount}/${totalCount} (${score}%)</p>`;
            html += `</div>`;
        } else {
            html += `<div class="alert alert-danger mb-4">`;
            html += `<h5>‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h5>`;
            html += `<p>${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}</p>`;
            html += `</div>`;
        }

        // –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
        if (data.tests && data.tests.length > 0) {
            html += '<h6>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤:</h6>';
            data.tests.forEach((test, index) => {
                const cssClass = test.passed ? 'passed' : 'failed';
                const icon = test.passed ? '‚úÖ' : '‚ùå';

                html += `<div class="test-result ${cssClass}">`;
                html += `<div class="test-description">${icon} –¢–µ—Å—Ç ${index + 1}: ${test.description}</div>`;
                if (test.message) {
                    html += `<div class="test-message">${test.message}</div>`;
                }
                html += `</div>`;
            });
        }

        // –í—ã–≤–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã
        if (data.output) {
            html += '<h6 class="mt-3">–í—ã–≤–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã:</h6>';
            html += `<pre class="bg-light p-2 rounded"><code>${data.output}</code></pre>`;
        }

        resultsContent.innerHTML = html;

        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
        resultsSection.scrollIntoView({ behavior: 'smooth' });
    }
});
</script>
{% endblock %}
