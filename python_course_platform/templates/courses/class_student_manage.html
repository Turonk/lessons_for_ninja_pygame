{% extends 'base.html' %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞–º–∏: {{ class_obj.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞–º–∏</h2>
                <p class="text-muted">–ö–ª–∞—Å—Å: <strong>{{ class_obj.name }}</strong></p>
            </div>
            <div>
                <a href="{% url 'courses:class_detail' class_obj.pk %}" class="btn btn-outline-secondary">
                    ‚Üê –ù–∞–∑–∞–¥ –∫ –∫–ª–∞—Å—Å—É
                </a>
                <a href="{% url 'courses:student_create' %}" class="btn btn-success">
                    ‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
                </a>
            </div>
        </div>

        <div class="row">
            <!-- –¢–µ–∫—É—â–∏–µ —É—á–µ–Ω–∏–∫–∏ –∫–ª–∞—Å—Å–∞ -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üë®‚Äçüéì –¢–µ–∫—É—â–∏–µ —É—á–µ–Ω–∏–∫–∏ ({{ current_students|length }})</h5>
                    </div>
                    <div class="card-body">
                        {% if current_students %}
                            <div class="list-group">
                                {% for student in current_students %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ student.get_full_name|default:student.username }}</strong>
                                            <br><small class="text-muted">{{ student.email }}</small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger"
                                                onclick="removeStudent({{ class_obj.pk }}, {{ student.pk }}, '{{ student.get_full_name|default:student.username }}')">
                                            ‚ùå –£–¥–∞–ª–∏—Ç—å
                                        </button>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <p class="text-muted">–í –∫–ª–∞—Å—Å–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</p>
                                <small class="text-muted">–î–æ–±–∞–≤—å—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã—Ö</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ —É—á–µ–Ω–∏–∫–∏ -->
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —É—á–µ–Ω–∏–∫–∏ ({{ available_students|length }})</h5>
                    </div>
                    <div class="card-body">
                        {% if available_students %}
                            <div class="list-group">
                                {% for student in available_students %}
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ student.get_full_name|default:student.username }}</strong>
                                            <br><small class="text-muted">{{ student.email }}</small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-success"
                                                onclick="addStudent({{ class_obj.pk }}, {{ student.pk }}, '{{ student.get_full_name|default:student.username }}')">
                                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å
                                        </button>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <p class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤</p>
                                <small class="text-muted">–í—Å–µ —É—á–µ–Ω–∏–∫–∏ —É–∂–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –ø–æ –∫–ª–∞—Å—Å–∞–º</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="text-success">{{ current_students|length }}</h3>
                        <p class="text-muted mb-0">–£—á–µ–Ω–∏–∫–æ–≤ –≤ –∫–ª–∞—Å—Å–µ</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body text-center">
                        <h3 class="text-info">{{ available_students|length }}</h3>
                        <p class="text-muted mb-0">–î–æ—Å—Ç—É–ø–Ω—ã—Ö —É—á–µ–Ω–∏–∫–æ–≤</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function addStudent(classId, studentId, studentName) {
    if (confirm(`–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞ "${studentName}" –≤ –∫–ª–∞—Å—Å?`)) {
        const url = `/api/courses/classes/${classId}/students/${studentId}/add/`;
        console.log('Generated URL:', url);
        console.log('classId:', classId, 'studentId:', studentId);

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —É—á–µ–Ω–∏–∫–∞');
        });
    }
}

function removeStudent(classId, studentId, studentName) {
    if (confirm(`–£–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞ "${studentName}" –∏–∑ –∫–ª–∞—Å—Å–∞? –£—á–µ–Ω–∏–∫ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ, –Ω–æ –ø–æ—Ç–µ—Ä—è–µ—Ç —Å–≤—è–∑—å —Å –∫–ª–∞—Å—Å–æ–º.`)) {
        const url = `/api/courses/classes/${classId}/students/${studentId}/remove/`;
        console.log('Generated URL for remove:', url);
        console.log('classId:', classId, 'studentId:', studentId);

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É—á–µ–Ω–∏–∫–∞');
        });
    }
}
</script>

{% endblock %}
