{% extends 'base.html' %}

{% block title %}–ö–ª–∞—Å—Å: {{ class_obj.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –¥–µ–π—Å—Ç–≤–∏—è -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2>üë• {{ class_obj.name }}</h2>
                <p class="text-muted">{{ class_obj.description }}</p>
            </div>
            {% if user.is_admin %}
                <div>
                    <a href="{% url 'courses:class_update' class_obj.pk %}" class="btn btn-outline-primary">
                        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å
                    </a>
                    <a href="{% url 'courses:class_student_manage' class_obj.pk %}" class="btn btn-success">
                        üë®‚Äçüéì ‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞
                    </a>
                    <a href="{% url 'courses:class_delete' class_obj.pk %}" class="btn btn-outline-danger"
                       onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–ª–∞—Å—Å? –£—á–µ–Ω–∏–∫–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º–µ, –Ω–æ –ø–æ—Ç–µ—Ä—è—é—Ç —Å–≤—è–∑—å —Å –∫–ª–∞—Å—Å–æ–º.')">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–ª–∞—Å—Å
                    </a>
                </div>
            {% endif %}
        </div>

        <div class="row">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∞—Å—Å–∞ -->
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∞—Å—Å–∞</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <h3 class="text-primary">{{ students|length }}</h3>
                                <p class="small">–£—á–µ–Ω–∏–∫–æ–≤</p>
                            </div>
                            <div class="col-6">
                                <h3 class="text-success">{{ available_topics|length }}</h3>
                                <p class="small">–î–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–º</p>
                            </div>
                        </div>
                        <hr>
                        <div class="small text-muted">
                            <strong>–°–æ–∑–¥–∞–Ω:</strong> {{ class_obj.created_at|date:"d.m.Y" }}<br>
                            <strong>–°–æ–∑–¥–∞–ª:</strong> {{ class_obj.created_by.get_full_name|default:class_obj.created_by.username }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–º—ã -->
            <div class="col-md-8 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5>üìö –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ–º—ã</h5>
                        {% if user.is_admin %}
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#topicAccessModal">
                                ‚öôÔ∏è –£–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ—Å—Ç—É–ø–æ–º
                            </button>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if available_topics %}
                            <div class="row">
                                {% for topic in available_topics %}
                                    <div class="col-md-6 mb-3">
                                        <div class="card h-100">
                                            <div class="card-body">
                                                <h6 class="card-title">{{ topic.title }}</h6>
                                                <p class="card-text small">{{ topic.description|truncatechars:100 }}</p>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="badge bg-info">{{ topic.active_tasks_count }} –∑–∞–¥–∞–Ω–∏–π</span>
                                                    <a href="{% url 'courses:topic_detail' topic.pk %}" class="btn btn-sm btn-outline-primary">
                                                        –ü—Ä–æ—Å–º–æ—Ç—Ä
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <p class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç–µ–º</p>
                                <small class="text-muted">–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–µ–º–∞–º</small>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- –°—Ç—É–¥–µ–Ω—Ç—ã –∫–ª–∞—Å—Å–∞ -->
        <div class="card">
            <div class="card-header">
                <h5>üë®‚Äçüéì –£—á–µ–Ω–∏–∫–∏ –∫–ª–∞—Å—Å–∞</h5>
            </div>
            <div class="card-body">
                {% if students %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>–ò–º—è</th>
                                    <th>Email</th>
                                    <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                                    <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                                    {% if user.is_admin and students_progress %}
                                        <th>–í—ã–ø–æ–ª–Ω–µ–Ω–æ –∑–∞–¥–∞–Ω–∏–π</th>
                                        <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}
                                    <tr>
                                        <td>{{ student.get_full_name|default:student.username }}</td>
                                        <td>{{ student.email }}</td>
                                        <td>{{ student.date_joined|date:"d.m.Y" }}</td>
                                        <td>{{ student.last_login|date:"d.m.Y H:i" }}</td>
                                        {% if user.is_admin %}
                                            <td>{{ student.completed_tasks|length }}</td>
                                            <td>
                                                {% if student.completed_tasks %}
                                                    <div class="progress" style="width: 100px;">
                                                        {% if total_available_tasks > 0 %}
                                                            {% with completed_count=student.completed_tasks|length %}
                                                                {% widthratio completed_count total_available_tasks 100 as progress_percent %}
                                                                <div class="progress-bar" role="progressbar"
                                                                     style="width: {{ progress_percent }}%"
                                                                     aria-valuenow="{{ progress_percent }}"
                                                                     aria-valuemin="0" aria-valuemax="100">
                                                                    {{ completed_count }}/{{ total_available_tasks }}
                                                                </div>
                                                            {% endwith %}
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted">–í –∫–ª–∞—Å—Å–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</p>
                        {% if user.is_admin %}
                            <a href="{% url 'courses:student_create' %}" class="btn btn-success">
                                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ç–µ–º–∞–º -->
{% if user.is_admin %}
<div class="modal fade" id="topicAccessModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∫ —Ç–µ–º–∞–º</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>–û—Ç–º–µ—Ç—å—Ç–µ —Ç–µ–º—ã, –∫ –∫–æ—Ç–æ—Ä—ã–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç –¥–æ—Å—Ç—É–ø –¥–ª—è —ç—Ç–æ–≥–æ –∫–ª–∞—Å—Å–∞:</p>
                <form id="topicAccessForm">
                    {% csrf_token %}
                    <input type="hidden" name="class_id" value="{{ class_obj.pk }}">
                    {% for topic in all_topics %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="topic_{{ topic.pk }}" name="topics" value="{{ topic.pk }}"
                                {% if topic in available_topics %}checked{% endif %}>
                            <label class="form-check-label" for="topic_{{ topic.pk }}">
                                <strong>{{ topic.title }}</strong>
                                <br><small class="text-muted">{{ topic.description|truncatechars:150 }}</small>
                            </label>
                        </div>
                    {% endfor %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveTopicAccess()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
function saveTopicAccess() {
    const form = document.getElementById('topicAccessForm');
    const formData = new FormData(form);

    fetch('{% url "courses:save_topic_access" class_obj.pk %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
    });
}
</script>
{% endif %}

{% endblock %}
